# Building Reusable ROS 2 Packages and Workspaces

This chapter details the process of structuring your ROS 2 projects into reusable packages and managing them within a `colcon` workspace. A well-organized workspace is crucial for collaborative development, code sharing, and efficient build processes.

## ROS 2 Package Structure

*   **Minimal Package**: Essential files (`package.xml`, `CMakeLists.txt`/`setup.py`).
*   **Source Files**: Organizing C++ (`src/`) and Python (`<package_name>/`) code.
*   **Message/Service/Action Definitions**: Placing custom interfaces (`msg/`, `srv/`, `action/`).

## `colcon` Workspaces

*   **Creating a Workspace**: Initializing your `colcon` workspace.
*   **Building Packages**: Using `colcon build` for efficient compilation.
*   **Sourcing the Workspace**: Making your installed packages available in the environment.
*   **Overlaying Workspaces**: Managing dependencies between different workspaces.

## Best Practices for Reusability

*   **Clear API**: Designing package interfaces for easy integration.
*   **Documentation**: Documenting package functionality and usage.
*   **Version Control**: Managing packages with Git.

## Example: Humanoid Control Package

Let's create a structured ROS 2 package for a simple humanoid controller within a `colcon` workspace. This package will demonstrate typical organization for Python nodes.

### 1. Package Structure

First, create the following directory structure in your ROS 2 workspace `src` folder (or in `examples/ros2_humanoid_control_example/` as we've done here):

```
examples/ros2_humanoid_control_example/
└── humanoid_control/
    ├── package.xml
    ├── CMakeLists.txt
    ├── setup.py
    ├── resource/
    │   └── humanoid_control
    └── humanoid_control/  # Python package directory
        └── simple_controller.py
```

### 2. Package Configuration Files

#### `package.xml`

This file describes the `humanoid_control` package, its version, description, maintainer, license, and dependencies.

```xml
<!-- examples/ros2_humanoid_control_example/humanoid_control/package.xml -->
<?xml version="1.0"?>
<?xml-model href="http://download.ros.org/schema/package_format3.xsd" schematypens="http://www.w3.org/2001/XMLSchema"?>
<package format="3">
  <name>humanoid_control</name>
  <version>0.0.0</version>
  <description>ROS 2 package for humanoid robot control examples</description>
  <maintainer email="user@example.com">user</maintainer>
  <license>Apache-2.0</license>

  <buildtool_depend>ament_cmake</buildtool_depend>
  <buildtool_depend>ament_python</buildtool_depend>

  <depend>rclpy</depend>
  <depend>std_msgs</depend>
  <depend>geometry_msgs</depend>

  <test_depend>ament_copyright</test_depend>
  <test_depend>ament_flake8</test_depend>
  <test_depend>ament_pep257</test_depend>
  <test_depend>python3-pytest</test_depend>

  <export>
    <build_type>ament_cmake</build_type>
  </export>
</package>
```

#### `CMakeLists.txt`

This file specifies how the package is built, including finding necessary ROS 2 packages and installing the Python package.

```cmake
# examples/ros2_humanoid_control_example/humanoid_control/CMakeLists.txt
cmake_minimum_required(VERSION 3.8)
project(humanoid_control)

if(CMAKE_COMPILER_ID STREQUAL "GNU")
  add_compile_options(-Wall -Wextra -Wpedantic)
endif()

find_package(ament_cmake REQUIRED)
find_package(ament_python REQUIRED)
find_package(rclpy REQUIRED)
find_package(std_msgs REQUIRED)
find_package(geometry_msgs REQUIRED)

ament_python_install_package(${PROJECT_NAME})

ament_package()
```

### 3. Python Node and Setup File

#### `setup.py`

This file defines the Python package, its entry points (console scripts), and data files.

```python
# examples/ros2_humanoid_control_example/humanoid_control/setup.py
from setuptools import setup

package_name = 'humanoid_control'

setup(
    name=package_name,
    version='0.0.0',
    packages=[package_name],
    data_files=[
        ('share/' + package_name, ['package.xml']),
        ('share/' + package_name + '/resource', ['resource/' + package_name]),
    ],
    install_requires=['setuptools'],
    zip_safe=True,
    maintainer='user',
    maintainer_email='user@example.com',
    description='ROS 2 package for humanoid robot control examples',
    license='Apache-2.0',
    tests_require=['pytest'],
    entry_points={
        'console_scripts': [
            'simple_controller = humanoid_control.simple_controller:main'
        ],
    },
)
```

#### `simple_controller.py`

A basic Python node that subscribes to high-level humanoid commands and provides feedback. In a real scenario, this would interface with joint controllers.

```python
# examples/ros2_humanoid_control_example/humanoid_control/humanoid_control/simple_controller.py
import rclpy
from rclpy.node import Node
from std_msgs.msg import String # For high-level commands, or use custom messages
# from geometry_msgs.msg import Pose # Example for joint control, etc.

class SimpleHumanoidController(Node):

    def __init__(self):
        super().__init__('simple_humanoid_controller')
        self.subscription = self.create_subscription(
            String, # Or a custom JointCommand message
            'humanoid_commands',
            self.command_listener_callback,
            10)
        self.subscription  # prevent unused variable warning
        self.publisher_ = self.create_publisher(String, 'humanoid_feedback', 10)
        self.get_logger().info('Simple Humanoid Controller Node Started')

    def command_listener_callback(self, msg):
        self.get_logger().info(f'Received command: "{msg.data}"')
        # Here, you would parse the command and translate it into robot actions
        # For a humanoid, this might involve:
        # - Inverse kinematics to calculate joint angles
        # - Publishing to joint trajectory controllers
        # - Managing balance and gait
        
        feedback_msg = String()
        feedback_msg.data = f'Executing: {msg.data}'
        self.publisher_.publish(feedback_msg)
        self.get_logger().info(f'Published feedback: "{feedback_msg.data}"')


def main(args=None):
    rclpy.init(args=args)
    simple_humanoid_controller = SimpleHumanoidController()
    rclpy.spin(simple_humanoid_controller)
    simple_humanoid_controller.destroy_node()
    rclpy.shutdown()

if __name__ == '__main__':
    main()
```

### 4. How to Build and Run

1.  Place the `humanoid_control` package (`examples/ros2_humanoid_control_example/humanoid_control/`) into the `src/` directory of your ROS 2 workspace.
2.  From the root of your ROS 2 workspace, build the package:
    ```bash
    colcon build --packages-select humanoid_control
    ```
3.  Source your workspace:
    ```bash
    source install/setup.bash
    ```
4.  Run the controller node:
    ```bash
    ros2 run humanoid_control simple_controller
    ```
5.  In a separate terminal, publish a command:
    ```bash
    ros2 topic pub --once /humanoid_commands std_msgs/msg/String "data: 'wave_arms'"
    ```
You should see the controller node receiving and acknowledging the command.

# Domain Randomization and Synthetic Data

This chapter explores the powerful techniques of domain randomization and synthetic data generation, essential for training robust AI models for robotics. By generating varied data in simulation, we can improve the ability of trained models to generalize to the complexities and uncertainties of the real world.

## The Reality Gap

*   **Definition**: The discrepancy between simulated environments and real-world conditions that often causes models trained in simulation to perform poorly on physical robots.
*   **Challenges**: Variations in lighting, textures, object properties, sensor noise, and physics.

## Domain Randomization

*   **Principle**: Randomizing non-critical aspects of the simulation environment during training, forcing the model to learn features that are invariant to these changes.
*   **Randomizable Parameters**:
    *   **Visual**: Lighting, textures, object colors, camera position.
    *   **Physical**: Friction, mass, damping, gravity.
    *   **Sensor**: Noise levels, calibration errors.
*   **Benefits**: Improves generalization, reduces reliance on real-world data collection, enhances robustness to unknown real-world conditions.

## Synthetic Data Generation

*   **Definition**: Creating labeled datasets from simulations.
*   **Advantages**:
    *   **Scale**: Generate massive amounts of data efficiently.
    *   **Cost-Effective**: Eliminates expensive and time-consuming manual labeling.
    *   **Perfect Labels**: Precise ground truth information (e.g., pixel-perfect segmentation masks, 3D poses).
    *   **Edge Cases**: Easily simulate rare or dangerous scenarios.

## Implementing Domain Randomization in Isaac Sim

*   **Randomizers API**: Using Isaac Sim's built-in tools for randomization.
*   **Data Recorder**: Capturing synthetic data (RGB-D images, semantic segmentation, bounding boxes, poses).

## Example: Randomizing Textures for Object Detection (Conceptual Isaac Sim Script)

This conceptual Python script for NVIDIA Isaac Sim demonstrates how to apply domain randomization to visual properties of objects (specifically color and scale) to generate diverse synthetic data. This helps train object detection models that are more robust to variations in the real world. We'll build upon our `examples/isaac_sim_environments/randomized_scene.py` file.

```python
# Conceptual Python script for Isaac Sim domain randomization
from omni.isaac.core import World
from omni.isaac.core.objects import DynamicCuboid
import numpy as np

# This script is meant to be run within the Isaac Sim environment.

def main():
    print("--- Initializing Isaac Sim World ---")
    world = World(stage_units_in_meters=1.0)
    world.scene.add_default_ground_plane()

    print("\n--- Applying Domain Randomization (Conceptual) ---")
    num_cuboids = 5
    for i in range(num_cuboids):
        # Randomize position
        pos_x = np.random.uniform(-0.5, 0.5)
        pos_y = np.random.uniform(-0.5, 0.5)
        pos_z = np.random.uniform(0.1, 0.5) # Ensure it's above the ground

        # Randomize scale
        scale = np.random.uniform(0.05, 0.2)
        
        # Randomize color (textures would be applied conceptually here)
        color = np.array([np.random.rand(), np.random.rand(), np.random.rand()])

        cuboid = world.scene.add(
            DynamicCuboid(
                prim_path=f"/World/random_cuboid_{i}",
                name=f"random_cuboid_{i}",
                position=np.array([pos_x, pos_y, pos_z]),
                size=scale,
                color=color,
            )
        )
        print(f"  Added cuboid {i}: Pos=({pos_x:.2f},{pos_y:.2f},{pos_z:.2f}), Size={scale:.2f}, Color={color}")

    # Reset the world to apply changes
    world.reset()

    print("\n--- Randomized Scene Setup Complete ---")
    print("In a real scenario, you would now use Isaac Sim's Data Recorder to capture synthetic data")
    print("from various camera viewpoints, with automatically generated labels (e.g., bounding boxes, segmentation masks).")

    # To run the simulation loop and data recording:
    # for i in range(num_data_samples):
    #     # Randomize parameters (e.g., lighting, background, object poses)
    #     # world.step(render=True)
    #     # recorder.record_data()

if __name__ == "__main__":
    # This example requires Isaac Sim to be running.
    # To execute: copy and paste into Isaac Sim Script Editor or run as an extension.
    main()
```

### Explanation

This conceptual script demonstrates key aspects of domain randomization:
1.  **Multiple Objects**: Instead of just one, multiple cuboids are added to the scene.
2.  **Randomized Properties**: For each cuboid, its position, size (scale), and color are randomized within a defined range. In a more advanced scenario, you would randomize textures, lighting, camera angles, and other environmental factors.
3.  **Synthetic Data Capture**: The explanation highlights how Isaac Sim's Data Recorder would then be used to capture images and automatically generated labels (like bounding boxes or segmentation masks) from this randomized scene.

This approach creates a vast and diverse synthetic dataset, making AI models trained on it more robust to the variations encountered in the real world.

### Reference

*   `examples/isaac_sim_environments/randomized_scene.py`

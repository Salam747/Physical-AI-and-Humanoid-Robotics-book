# Sensor Simulation

This chapter explores the crucial aspect of simulating robot sensors to generate data that closely mimics real-world hardware. Accurate sensor simulation is vital for developing and testing perception algorithms, ensuring that software trained in simulation performs reliably on physical robots.

## Principles of Sensor Simulation

*   **Fidelity vs. Performance**: Balancing the realism of simulation with computational cost.
*   **Noise Models**: Incorporating realistic noise profiles (Gaussian, speckle, random walk) for various sensor types.
*   **Calibration**: Simulating sensor calibration errors and offsets.
*   **Environmental Factors**: Modeling how light, weather, and object properties affect sensor readings.

## Simulating Common Robot Sensors

*   **LiDAR (Velodyne/Hesai models)**: Simulating 2D/3D point clouds, range, and intensity data with realistic noise.
*   **Depth Cameras (Intel RealSense D435i/D455)**: Simulating RGB-D streams, including depth noise, IR patterns, and field of view limitations.
*   **IMUs (Inertial Measurement Units)**: Simulating accelerometer and gyroscope data with bias, drift, and white noise.
*   **RGB Cameras**: Simulating visual images with realistic lighting, shadows, and lens effects.

## Integrating Simulated Sensors

*   **ROS 2 Sensor Interfaces**: Publishing simulated sensor data to standard ROS 2 topics.
*   **Simulator APIs**: Using APIs from Gazebo, Isaac Sim, or Unity to access and configure sensor models.

## Example: Noisy Depth Camera Feed (Conceptual Isaac Sim Script)

This conceptual Python script for NVIDIA Isaac Sim demonstrates how to configure a depth camera with realistic noise parameters, drawing from our `examples/simulation_configs/sensor_noise_config.json`.

```python
# Conceptual Python script for Isaac Sim (not directly executable as standalone)
import omni.isaac.core as icore
import json
import numpy as np

# Assuming an Isaac Sim environment is already set up and running
# world = icore.World(stage_units_in_meters=1.0)

def load_sensor_config(config_path):
    with open(config_path, 'r') as f:
        return json.load(f)

def setup_depth_camera(camera_prim_path, noise_config):
    # This is conceptual. In Isaac Sim, you'd configure the camera sensor properties directly
    # and add post-processing effects for noise.

    # Example of setting depth noise parameters
    depth_noise_std_dev = noise_config["depth_camera"]["depth_noise_std_dev"]
    ir_noise_std_dev = noise_config["depth_camera"]["ir_noise_std_dev"]

    print(f"Configuring depth camera at {camera_prim_path}:")
    print(f"  Depth Noise Std Dev: {depth_noise_std_dev}")
    print(f"  IR Noise Std Dev: {ir_noise_std_dev}")

    # Conceptual representation of applying noise model
    # camera_prim = icore.utils.prims.get_prim_at_path(camera_prim_path)
    # if camera_prim:
    #     camera_sensor = camera_prim.get_applied_schema("CameraSensor")
    #     if camera_sensor:
    #         camera_sensor.createAttribute("noise:depthStdDev").set(depth_noise_std_dev)
    #         camera_sensor.createAttribute("noise:irStdDev").set(ir_noise_std_dev)
    #         # Add other noise parameters like dropouts, speckle, etc.
    # else:
    #     print(f"Error: Camera prim not found at {camera_prim_path}")

def simulate_and_get_noisy_data():
    # In a real simulation, you would step the world and retrieve sensor data
    # raw_depth_data = camera.get_depth_data()
    # noisy_depth_data = add_noise_to_data(raw_depth_data, depth_noise_std_dev)
    
    # Simulate a noisy depth reading
    simulated_noisy_depth = np.random.normal(loc=1.5, scale=0.01, size=(100, 100)) # Example noisy data
    print(f"Simulated noisy depth data snippet (mean): {np.mean(simulated_noisy_depth):.4f}m")
    print(f"Simulated noisy depth data snippet (std dev): {np.std(simulated_noisy_depth):.4f}m")

def main():
    print("--- Loading Sensor Noise Configurations ---")
    sensor_configs = load_sensor_config("examples/simulation_configs/sensor_noise_config.json")

    camera_prim_path = "/World/Robot/Camera" # Conceptual path to a camera sensor
    setup_depth_camera(camera_prim_path, sensor_configs)

    print("\n--- Simulating Noisy Depth Feed ---")
    simulate_and_get_noisy_data()

if __name__ == '__main__':
    main()
```

### Explanation

This conceptual script demonstrates:
1.  **Loading Configuration**: It loads `sensor_noise_config.json` to get predefined sensor noise parameters.
2.  **Camera Setup**: Conceptually configures a depth camera sensor within an Isaac Sim environment, applying the loaded noise models.
3.  **Simulated Data**: It then simulates generating a noisy depth data feed, showing how the configured noise would manifest.

By applying these noise models, your simulated sensor data will more closely resemble the output of real hardware, making your perception algorithms more robust.

### Reference

*   `examples/simulation_configs/sensor_noise_config.json`
